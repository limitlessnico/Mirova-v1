name: An√°lisis Black Box

# Este workflow se ejecuta MANUALMENTE cuando t√∫ lo decidas
on:
  workflow_dispatch:
    inputs:
      fecha_analisis:
        description: 'Fecha del an√°lisis (para documentaci√≥n)'
        required: false
        default: '2026-01-20'

permissions:
  contents: write

jobs:
  analizar_blackbox:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necesitamos todo el historial

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ejecutar An√°lisis Black Box
        run: |
          echo "üî¨ Iniciando an√°lisis Black Box..."
          python analisis_blackbox_final.py
          echo "‚úÖ An√°lisis completado"

      - name: Mostrar resultados en log
        run: |
          echo ""
          echo "========================================"
          echo "üìä ARCHIVOS GENERADOS:"
          echo "========================================"
          ls -lh monitoreo_satelital/eventos_perdidos_confirmados.csv 2>/dev/null || echo "‚ö†Ô∏è No se generaron eventos perdidos"
          echo ""
          echo "========================================"
          echo "üìÑ VISTA PREVIA EVENTOS PERDIDOS:"
          echo "========================================"
          if [ -f monitoreo_satelital/eventos_perdidos_confirmados.csv ]; then
            head -20 monitoreo_satelital/eventos_perdidos_confirmados.csv
            echo ""
            echo "Total de l√≠neas: $(wc -l < monitoreo_satelital/eventos_perdidos_confirmados.csv)"
          else
            echo "‚úÖ No hay eventos perdidos - Captura al 100%"
          fi

      - name: Crear reporte resumen
        run: |
          cat > monitoreo_satelital/REPORTE_BLACKBOX_$(date +%Y%m%d).md << 'EOF'
          # üìä Reporte An√°lisis Black Box
          
          **Fecha:** $(date +%Y-%m-%d\ %H:%M:%S\ UTC)
          
          ## Resultados
          
          Ver archivo: `eventos_perdidos_confirmados.csv`
          
          ## Estad√≠sticas
          
          ```
          $(if [ -f monitoreo_satelital/eventos_perdidos_confirmados.csv ]; then
            total=$(wc -l < monitoreo_satelital/eventos_perdidos_confirmados.csv)
            echo "Total eventos perdidos: $((total - 1))"
            echo ""
            echo "Desglose por volc√°n:"
            tail -n +2 monitoreo_satelital/eventos_perdidos_confirmados.csv | cut -d',' -f3 | sort | uniq -c | sort -rn
          else
            echo "‚úÖ No hay eventos perdidos"
          fi)
          ```
          
          ## Conclusi√≥n
          
          $(if [ -f monitoreo_satelital/eventos_perdidos_confirmados.csv ]; then
            echo "Se detectaron p√©rdidas de datos. Revisar archivo CSV para detalles."
          else
            echo "‚úÖ Sistema funcionando perfectamente - Captura al 100%"
          fi)
          EOF

      - name: Guardar resultados en GitHub
        run: |
          git config --global user.name "VolcanoAnalyzer"
          git config --global user.email "analyzer@volcano.com"
          
          # Agregar archivos generados
          git add monitoreo_satelital/eventos_perdidos_confirmados.csv 2>/dev/null || true
          git add monitoreo_satelital/REPORTE_BLACKBOX_*.md 2>/dev/null || true
          
          # Commit solo si hay cambios
          if ! git diff --quiet --staged; then
            git commit -m "üìä An√°lisis Black Box: $(date +%Y-%m-%d)"
            git pull origin main --rebase -X ours
            git push origin main
            echo "‚úÖ Resultados guardados en repositorio"
          else
            echo "‚ÑπÔ∏è No hay nuevos resultados para guardar"
          fi

      - name: Crear Issue con resumen (opcional)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Leer archivo de eventos perdidos si existe
            let contenido = '‚úÖ **No se detectaron eventos perdidos**\n\nEl sistema est√° capturando todos los datos correctamente.';
            
            try {
              const csv = fs.readFileSync('monitoreo_satelital/eventos_perdidos_confirmados.csv', 'utf8');
              const lineas = csv.split('\n');
              const total = lineas.length - 2; // -1 header, -1 √∫ltima l√≠nea vac√≠a
              
              if (total > 0) {
                contenido = `‚ö†Ô∏è **Se detectaron ${total} eventos perdidos**\n\n`;
                contenido += '### Primeros 10 eventos:\n\n';
                contenido += '```\n';
                contenido += lineas.slice(0, 11).join('\n');
                contenido += '\n```\n\n';
                contenido += 'Ver archivo completo: `monitoreo_satelital/eventos_perdidos_confirmados.csv`';
              }
            } catch (error) {
              // Archivo no existe = no hay p√©rdidas
            }
            
            // Crear issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üìä An√°lisis Black Box - ${new Date().toISOString().split('T')[0]}`,
              body: `# An√°lisis Black Box Completado\n\n${contenido}\n\n---\n*Generado autom√°ticamente por GitHub Actions*`,
              labels: ['an√°lisis', 'black-box']
            });
