name: Verificaci√≥n Black Box FINAL (Chile Only)

on:
  workflow_dispatch:

jobs:
  verificar-blackbox:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Instalar dependencias
        run: |
          pip install pandas beautifulsoup4 lxml --break-system-packages
      
      - name: Script FINAL - B√∫squeda sin mapeo
        run: |
          cat > verificar_blackbox_final.py << 'EOFPYTHON'
          #!/usr/bin/env python3
          import os
          from datetime import datetime
          from bs4 import BeautifulSoup
          import pandas as pd
          from pathlib import Path
          import glob
          
          BLACKBOX_DIR = "monitoreo_satelital/blackbox_latest"
          
          # VOLCANES CHILENOS - Nombres como aparecen en HTML de Black Box
          VOLCANES_CHILENOS = {
              'Lascar', 'Lastarria', 'Isluga', 'Villarrica', 'Llaima',
              'ChillanNevadosde',  # Sin espacios (como est√° en HTML)
              'Copahue', 
              'PuyehueCordonCaulle',  # Sin guiones (como est√° en HTML)
              'Chaiten', 'PlanchonPeteroa'
          }
          
          IMAGE_TIMESTAMPS = {
              'VIIRS': {
                  'Lascar': ['2026-01-19 05:54:01', '2026-01-19 05:30:00', '2026-01-18 18:36:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 19:00:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01'],
                  'ChillanNevadosde': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 18:36:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 06:36:01', '2026-01-17 06:12:00'],
                  'Villarrica': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00'],
                  'Copahue': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00', '2026-01-17 06:36:01'],
                  'Lastarria': ['2026-01-19 05:54:01', '2026-01-19 05:30:00', '2026-01-18 18:36:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 18:54:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01'],
                  'PuyehueCordonCaulle': ['2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00', '2026-01-17 06:36:01'],
                  'PlanchonPeteroa': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:12:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:36:00', '2026-01-17 06:36:01'],
                  'Llaima': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00'],
                  'Chaiten': ['2026-01-19 06:00:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 20:12:00', '2026-01-17 18:54:01'],
                  'Isluga': ['2026-01-19 05:48:01', '2026-01-19 05:30:00', '2026-01-18 18:42:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 19:00:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01']
              },
              'VIIRS375': {
                  'Chaiten': ['2026-01-19 06:00:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 20:12:00', '2026-01-17 18:54:01'],
                  'ChillanNevadosde': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:12:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 06:36:01', '2026-01-17 06:12:00'],
                  'Copahue': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00', '2026-01-17 06:36:01'],
                  'Isluga': ['2026-01-19 05:48:01', '2026-01-19 05:30:00', '2026-01-18 18:42:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 19:00:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01'],
                  'Lascar': ['2026-01-19 05:54:01', '2026-01-19 05:30:00', '2026-01-18 18:36:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 19:00:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01'],
                  'Lastarria': ['2026-01-19 05:54:01', '2026-01-19 05:30:00', '2026-01-18 18:36:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 18:54:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01'],
                  'Llaima': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00'],
                  'PlanchonPeteroa': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:12:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:36:00', '2026-01-17 06:36:01'],
                  'PuyehueCordonCaulle': ['2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00', '2026-01-17 06:36:01']
              },
              'MODIS': {
                  'ChillanNevadosde': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 19:25:00', '2026-01-17 14:00:00'],
                  'Copahue': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 06:30:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 19:25:00'],
                  'Lascar': ['2026-01-19 13:35:00', '2026-01-19 07:05:00', '2026-01-19 01:05:00', '2026-01-18 20:10:00', '2026-01-18 12:55:00', '2026-01-18 08:00:00', '2026-01-18 02:00:00', '2026-01-17 19:30:00', '2026-01-17 13:55:00', '2026-01-17 07:25:00'],
                  'Lastarria': ['2026-01-19 13:35:00', '2026-01-19 07:05:00', '2026-01-18 20:10:00', '2026-01-18 12:55:00', '2026-01-18 08:05:00', '2026-01-18 02:00:00', '2026-01-17 19:30:00', '2026-01-17 13:55:00', '2026-01-17 07:25:00', '2026-01-17 01:25:00'],
                  'PlanchonPeteroa': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:40:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 19:25:00', '2026-01-17 14:00:00'],
                  'PuyehueCordonCaulle': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 06:30:00', '2026-01-17 21:05:00', '2026-01-17 14:00:00', '2026-01-17 07:30:00'],
                  'Villarrica': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 06:30:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 14:00:00'],
                  'Llaima': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 06:30:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 14:00:00'],
                  'Chaiten': ['2026-01-19 13:40:00', '2026-01-19 07:10:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 06:30:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 14:00:00'],
                  'Isluga': ['2026-01-19 13:35:00', '2026-01-19 07:05:00', '2026-01-19 01:05:00', '2026-01-18 20:10:00', '2026-01-18 12:55:00', '2026-01-18 08:00:00', '2026-01-18 02:00:00', '2026-01-17 19:30:00', '2026-01-17 13:55:00', '2026-01-17 07:25:00']
              }
          }
          
          # Crear √≠ndice de timestamps - SIN MAPEO, nombres directos
          TIMESTAMPS_BUSCAR = {}
          for sensor, volcanes in IMAGE_TIMESTAMPS.items():
              for volcano, timestamps in volcanes.items():
                  # CLAVE: Usar el nombre directo del volc√°n (sin mapeo)
                  for ts_str in timestamps:
                      dt = datetime.strptime(ts_str, '%Y-%m-%d %H:%M:%S')
                      key = (volcano, dt, sensor)  # ‚Üê volcano directo (ChillanNevadosde, PuyehueCordonCaulle)
                      TIMESTAMPS_BUSCAR[key] = ts_str
          
          print("="*80)
          print("VERIFICACI√ìN FINAL - B√∫squeda directa sin mapeo")
          print("="*80)
          print(f"Timestamps a buscar: {len(TIMESTAMPS_BUSCAR)}")
          
          def parse_blackbox_html_optimizado(html_file):
              """Parse HTML SOLO volcanes chilenos"""
              with open(html_file, 'r', encoding='utf-8') as f:
                  soup = BeautifulSoup(f.read(), 'html.parser')
              
              eventos_chile = {}
              
              table = soup.find('table', {'id': 'volcanoTable'})
              if not table:
                  return eventos_chile
              
              tbody = table.find('tbody')
              if not tbody:
                  return eventos_chile
              
              rows = tbody.find_all('tr')
              
              for row in rows:
                  cols = row.find_all('td')
                  if len(cols) < 6:
                      continue
                  
                  try:
                      volcano_link = cols[2].find('a')
                      volcan = volcano_link.text.strip() if volcano_link else cols[2].text.strip()
                      
                      # Filtro: Solo volcanes chilenos
                      if volcan not in VOLCANES_CHILENOS:
                          continue
                      
                      fecha_str = cols[0].text.strip()
                      sensor = cols[5].text.strip()
                      
                      dt = datetime.strptime(fecha_str, '%d-%b-%Y %H:%M:%S')
                      
                      # Key con nombre directo (SIN mapeo)
                      key = (volcan, dt, sensor)
                      eventos_chile[key] = True
                      
                  except:
                      continue
              
              return eventos_chile
          
          # Buscar archivos
          base_path = Path(BLACKBOX_DIR)
          html_pattern = str(base_path / "*" / "latest_*.html")
          html_files = sorted(glob.glob(html_pattern))
          
          print(f"Snapshots encontrados: {len(html_files)}")
          
          # Parsear todos los HTMLs
          print("\nParseando snapshots...")
          eventos_encontrados_global = {}
          
          for idx, html_file in enumerate(html_files, 1):
              if idx % 100 == 0:
                  print(f"  {idx}/{len(html_files)}...")
              
              eventos = parse_blackbox_html_optimizado(html_file)
              filename = Path(html_file).name
              folder = Path(html_file).parent.name
              
              for key in eventos:
                  if key not in eventos_encontrados_global:
                      eventos_encontrados_global[key] = f"{folder}/{filename}"
          
          print(f"\n‚úÖ Eventos chilenos √∫nicos: {len(eventos_encontrados_global)}")
          
          # Verificar timestamps
          print("\nVerificando timestamps...")
          resultados = []
          total_encontrados = 0
          
          for key, ts_original in TIMESTAMPS_BUSCAR.items():
              volcano, dt, sensor = key
              
              if key in eventos_encontrados_global:
                  total_encontrados += 1
                  status = "EN_BLACKBOX"
                  snapshot = eventos_encontrados_global[key]
                  minuto = dt.strftime('%Y-%m-%d %H:%M:%S')
              else:
                  status = "NO_EN_BLACKBOX"
                  snapshot = "N/A"
                  minuto = "N/A"
              
              resultados.append({
                  'Sensor': sensor,
                  'Volcan': volcano,  # ‚Üê Nombre directo (ChillanNevadosde, PuyehueCordonCaulle)
                  'Timestamp_Imagen': ts_original,
                  'Estado': status,
                  'Snapshot': snapshot,
                  'Minuto_Captura': minuto
              })
          
          # Guardar CSV
          df = pd.DataFrame(resultados)
          output_file = 'monitoreo_satelital/verificacion_blackbox_FINAL.csv'
          df.to_csv(output_file, index=False)
          
          # Resumen
          print("\n" + "="*80)
          print("RESUMEN POR SENSOR")
          print("="*80)
          
          for sensor in ['VIIRS', 'VIIRS375', 'MODIS']:
              df_sensor = df[df['Sensor'] == sensor]
              encontrados = len(df_sensor[df_sensor['Estado'] == 'EN_BLACKBOX'])
              total = len(df_sensor)
              if total > 0:
                  print(f"{sensor:10}: {encontrados}/{total} ({encontrados/total*100:.1f}%)")
          
          print("\n" + "="*80)
          print("RESUMEN POR VOLC√ÅN")
          print("="*80)
          
          for volcan in sorted(df['Volcan'].unique()):
              df_v = df[df['Volcan'] == volcan]
              encontrados = len(df_v[df_v['Estado'] == 'EN_BLACKBOX'])
              total = len(df_v)
              print(f"{volcan:25}: {encontrados}/{total} ({encontrados/total*100:.1f}%)")
          
          total = len(resultados)
          print(f"\n{'='*80}")
          print(f"TOTAL: {total_encontrados}/{total} ({total_encontrados/total*100:.1f}%)")
          print(f"\n‚úÖ CSV: {output_file}")
          EOFPYTHON
      
      - name: Ejecutar verificaci√≥n FINAL
        run: python3 verificar_blackbox_final.py
      
      - name: Commit y Push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git pull --rebase origin main
          git add monitoreo_satelital/verificacion_blackbox_FINAL.csv
          git commit -m "üìä Verificaci√≥n Black Box FINAL sin mapeo: $(date +'%Y-%m-%d %H:%M')" || echo "No changes"
          git pull --rebase origin main
          git push
      
      - name: Mostrar resultados
        run: |
          echo "‚úÖ Completado"
          if [ -f monitoreo_satelital/verificacion_blackbox_FINAL.csv ]; then
            head -30 monitoreo_satelital/verificacion_blackbox_FINAL.csv
          fi
