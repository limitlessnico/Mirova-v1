name: Verificaci√≥n Black Box - Im√°genes vs Snapshots

on:
  workflow_dispatch:  # Ejecutar manualmente

jobs:
  verificar-blackbox:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Instalar dependencias
        run: |
          pip install pandas beautifulsoup4 lxml --break-system-packages
      
      - name: Crear script de verificaci√≥n
        run: |
          cat > verificar_blackbox.py << 'EOFPYTHON'
          #!/usr/bin/env python3
          import os
          import re
          from datetime import datetime
          from bs4 import BeautifulSoup
          import pandas as pd
          from pathlib import Path
          
          BLACKBOX_DIR = "monitoreo_satelital/blackbox_latest"
          
          VOLCANO_MAPPING = {
              'Lascar': 'Lascar',
              'ChillanNevadosde': 'Nevados de Chillan',
              'Villarrica': 'Villarrica',
              'Copahue': 'Copahue',
              'Lastarria': 'Lastarria',
              'PuyehueCordonCaulle': 'Puyehue-Cordon Caulle',
              'PlanchonPeteroa': 'PlanchonPeteroa',
              'Llaima': 'Llaima',
              'Chaiten': 'Chaiten',
              'Isluga': 'Isluga'
          }
          
          IMAGE_TIMESTAMPS = {
              'VIIRS': {
                  'Lascar': ['2026-01-19 05:54:01', '2026-01-19 05:30:00', '2026-01-18 18:36:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 19:00:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01'],
                  'ChillanNevadosde': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 18:36:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 06:36:01', '2026-01-17 06:12:00'],
                  'Villarrica': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00'],
                  'Copahue': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00', '2026-01-17 06:36:01'],
                  'Lastarria': ['2026-01-19 05:54:01', '2026-01-19 05:30:00', '2026-01-18 18:36:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 18:54:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01'],
                  'PuyehueCordonCaulle': ['2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00', '2026-01-17 06:36:01'],
                  'PlanchonPeteroa': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:12:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:36:00', '2026-01-17 06:36:01'],
                  'Llaima': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00'],
                  'Chaiten': ['2026-01-19 06:00:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 20:12:00', '2026-01-17 18:54:01'],
                  'Isluga': ['2026-01-19 05:48:01', '2026-01-19 05:30:00', '2026-01-18 18:42:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 19:00:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01']
              },
              'VIIRS375': {
                  'Chaiten': ['2026-01-19 06:00:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 20:12:00', '2026-01-17 18:54:01'],
                  'ChillanNevadosde': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:12:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 06:36:01', '2026-01-17 06:12:00'],
                  'Copahue': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00', '2026-01-17 06:36:01'],
                  'Isluga': ['2026-01-19 05:48:01', '2026-01-19 05:30:00', '2026-01-18 18:42:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 19:00:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01'],
                  'Lascar': ['2026-01-19 05:54:01', '2026-01-19 05:30:00', '2026-01-18 18:36:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 19:00:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01'],
                  'Lastarria': ['2026-01-19 05:54:01', '2026-01-19 05:30:00', '2026-01-18 18:36:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 18:54:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01'],
                  'Llaima': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00'],
                  'PlanchonPeteroa': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:12:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:36:00', '2026-01-17 06:36:01'],
                  'PuyehueCordonCaulle': ['2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00', '2026-01-17 06:36:01']
              },
              'MODIS': {
                  'ChillanNevadosde': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 19:25:00', '2026-01-17 14:00:00'],
                  'Copahue': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 06:30:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 19:25:00'],
                  'Lascar': ['2026-01-19 13:35:00', '2026-01-19 07:05:00', '2026-01-19 01:05:00', '2026-01-18 20:10:00', '2026-01-18 12:55:00', '2026-01-18 08:00:00', '2026-01-18 02:00:00', '2026-01-17 19:30:00', '2026-01-17 13:55:00', '2026-01-17 07:25:00'],
                  'Lastarria': ['2026-01-19 13:35:00', '2026-01-19 07:05:00', '2026-01-18 20:10:00', '2026-01-18 12:55:00', '2026-01-18 08:05:00', '2026-01-18 02:00:00', '2026-01-17 19:30:00', '2026-01-17 13:55:00', '2026-01-17 07:25:00', '2026-01-17 01:25:00'],
                  'PlanchonPeteroa': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:40:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 19:25:00', '2026-01-17 14:00:00'],
                  'PuyehueCordonCaulle': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 06:30:00', '2026-01-17 21:05:00', '2026-01-17 14:00:00', '2026-01-17 07:30:00'],
                  'Villarrica': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 06:30:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 14:00:00'],
                  'Llaima': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 06:30:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 14:00:00'],
                  'Chaiten': ['2026-01-19 13:40:00', '2026-01-19 07:10:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 06:30:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 14:00:00'],
                  'Isluga': ['2026-01-19 13:35:00', '2026-01-19 07:05:00', '2026-01-19 01:05:00', '2026-01-18 20:10:00', '2026-01-18 12:55:00', '2026-01-18 08:00:00', '2026-01-18 02:00:00', '2026-01-17 19:30:00', '2026-01-17 13:55:00', '2026-01-17 07:25:00']
              }
          }
          
          def parse_blackbox_html(html_file):
              with open(html_file, 'r', encoding='utf-8') as f:
                  soup = BeautifulSoup(f.read(), 'html.parser')
              eventos = []
              table = soup.find('table')
              if not table:
                  return eventos
              rows = table.find_all('tr')[1:]
              for row in rows:
                  cols = row.find_all('td')
                  if len(cols) >= 4:
                      try:
                          volcan = cols[0].text.strip()
                          fecha_str = cols[1].text.strip()
                          sensor = cols[2].text.strip()
                          vrp = cols[3].text.strip()
                          dt = datetime.strptime(fecha_str, '%Y-%m-%d %H:%M:%S')
                          eventos.append({'volcan': volcan, 'timestamp': dt, 'sensor': sensor, 'vrp': vrp})
                      except:
                          continue
              return eventos
          
          def buscar_evento(volcano, timestamp_str, sensor):
              target_dt = datetime.strptime(timestamp_str, '%Y-%m-%d %H:%M:%S')
              volcano_csv = VOLCANO_MAPPING.get(volcano, volcano)
              blackbox_path = Path(BLACKBOX_DIR)
              html_files = sorted(blackbox_path.glob('*.html'))
              for html_file in html_files:
                  eventos = parse_blackbox_html(html_file)
                  for evento in eventos:
                      if (evento['volcan'] == volcano_csv and evento['timestamp'] == target_dt and evento['sensor'] == sensor):
                          match = re.search(r'(\d{8})_(\d{6})', html_file.stem)
                          if match:
                              captura_dt = datetime.strptime(f"{match.group(1)}{match.group(2)}", '%Y%m%d%H%M%S')
                              return True, html_file.name, captura_dt
                          return True, html_file.name, None
              return False, None, None
          
          print("="*80)
          print("VERIFICACI√ìN: IM√ÅGENES vs BLACK BOX")
          print("="*80)
          
          blackbox_path = Path(BLACKBOX_DIR)
          num_files = len(list(blackbox_path.glob('*.html')))
          print(f"Snapshots encontrados: {num_files}")
          
          resultados = []
          for sensor, volcanes in IMAGE_TIMESTAMPS.items():
              print(f"\n{sensor}:")
              for volcano, timestamps in volcanes.items():
                  encontrados = 0
                  for ts in timestamps:
                      found, snapshot, captura_dt = buscar_evento(volcano, ts, sensor)
                      if found:
                          encontrados += 1
                          status = "EN_BLACKBOX"
                          minuto = captura_dt.strftime('%Y-%m-%d %H:%M:%S') if captura_dt else "N/A"
                      else:
                          status = "NO_EN_BLACKBOX"
                          minuto = "N/A"
                          snapshot = "N/A"
                      resultados.append({'Sensor': sensor, 'Volcan': volcano, 'Timestamp_Imagen': ts, 'Estado': status, 'Snapshot': snapshot if snapshot else "N/A", 'Minuto_Captura': minuto})
                  print(f"  {volcano}: {encontrados}/{len(timestamps)} encontrados")
          
          df = pd.DataFrame(resultados)
          df.to_csv('monitoreo_satelital/analisis_imagenes_vs_blackbox.csv', index=False)
          
          total = len(resultados)
          encontrados_total = len([r for r in resultados if r['Estado'] == "EN_BLACKBOX"])
          print(f"\nRESUMEN: {encontrados_total}/{total} encontrados ({encontrados_total/total*100:.1f}%)")
          print("CSV guardado: monitoreo_satelital/analisis_imagenes_vs_blackbox.csv")
          EOFPYTHON
      
      - name: Ejecutar verificaci√≥n
        run: python3 verificar_blackbox.py
      
      - name: Commit y Push resultados
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add monitoreo_satelital/analisis_imagenes_vs_blackbox.csv
          git commit -m "üìä Verificaci√≥n Black Box vs Im√°genes: $(date +'%Y-%m-%d %H:%M')" || echo "No changes"
          git push
      
      - name: Resumen en logs
        run: |
          echo "‚úÖ Verificaci√≥n completada"
          echo "üìÅ Archivo generado: monitoreo_satelital/analisis_imagenes_vs_blackbox.csv"
          if [ -f monitoreo_satelital/analisis_imagenes_vs_blackbox.csv ]; then
            echo "üìä Primeras l√≠neas:"
            head -20 monitoreo_satelital/analisis_imagenes_vs_blackbox.csv
          fi
