name: Scraper OCR

on:
  schedule:
    # Cada 1 hora en el minuto :05
    - cron: '5 * * * *'
  
  # Permitir ejecuci√≥n manual
  workflow_dispatch:

concurrency:
  group: scraper-ocr
  cancel-in-progress: true

jobs:
  ocr_scraper:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar dependencias del sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-eng

      - name: Instalar dependencias Python
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ejecutar Scraper OCR
        run: python scraper_ocr.py

      - name: Ejecutar Merger Maestro
        run: python merger_maestro.py

      - name: Regenerar Gr√°ficos
        run: python visualizador.py

      - name: Guardar cambios en GitHub
        run: |
          git config --global user.name "VolcanoOCR"
          git config --global user.email "ocr@volcano.com"
          git add -A
          
          if ! git diff --quiet --staged; then
            git commit -m "üî¨ OCR: Captura de eventos satelitales"
            
            # Push con reintentos
            max_retries=5
            retry_count=0
            
            while [ $retry_count -lt $max_retries ]; do
              echo "Intento $((retry_count + 1)) de push..."
              
              if git pull origin main --rebase -X ours; then
                echo "Pull exitoso, intentando push..."
              else
                echo "‚ö†Ô∏è Pull fall√≥, continuando..."
              fi
              
              if git push origin main; then
                echo "‚úÖ Push exitoso en intento $((retry_count + 1))"
                exit 0
              else
                echo "‚ö†Ô∏è Push fall√≥, esperando antes de reintentar..."
                retry_count=$((retry_count + 1))
                
                if [ $retry_count -lt $max_retries ]; then
                  sleep $((retry_count * 2))
                fi
              fi
            done
            
            echo "‚ùå Push fall√≥ despu√©s de $max_retries intentos"
            exit 1
          else
            echo "‚ÑπÔ∏è No hay eventos nuevos para subir."
          fi
