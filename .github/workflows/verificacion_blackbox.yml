name: Verificaci√≥n Black Box v2 - CORREGIDO

on:
  workflow_dispatch:

jobs:
  verificar-blackbox:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Instalar dependencias
        run: |
          pip install pandas beautifulsoup4 lxml --break-system-packages
      
      - name: Crear script de verificaci√≥n CORREGIDO
        run: |
          cat > verificar_blackbox.py << 'EOFPYTHON'
          #!/usr/bin/env python3
          import os
          import re
          from datetime import datetime
          from bs4 import BeautifulSoup
          import pandas as pd
          from pathlib import Path
          import glob
          
          # ESTRUCTURA CORRECTA: blackbox_latest/YYYY-MM-DD/latest_YYYYMMDD_HHMMSS.html
          BLACKBOX_DIR = "monitoreo_satelital/blackbox_latest"
          
          VOLCANO_MAPPING = {
              'Lascar': 'Lascar',
              'ChillanNevadosde': 'Nevados de Chillan',
              'Villarrica': 'Villarrica',
              'Copahue': 'Copahue',
              'Lastarria': 'Lastarria',
              'PuyehueCordonCaulle': 'Puyehue-Cordon Caulle',
              'PlanchonPeteroa': 'PlanchonPeteroa',
              'Llaima': 'Llaima',
              'Chaiten': 'Chaiten',
              'Isluga': 'Isluga'
          }
          
          IMAGE_TIMESTAMPS = {
              'VIIRS': {
                  'Lascar': ['2026-01-19 05:54:01', '2026-01-19 05:30:00', '2026-01-18 18:36:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 19:00:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01'],
                  'ChillanNevadosde': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 18:36:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 06:36:01', '2026-01-17 06:12:00'],
                  'Villarrica': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00'],
                  'Copahue': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00', '2026-01-17 06:36:01'],
                  'Lastarria': ['2026-01-19 05:54:01', '2026-01-19 05:30:00', '2026-01-18 18:36:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 18:54:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01'],
                  'PuyehueCordonCaulle': ['2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00', '2026-01-17 06:36:01'],
                  'PlanchonPeteroa': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:12:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:36:00', '2026-01-17 06:36:01'],
                  'Llaima': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00'],
                  'Chaiten': ['2026-01-19 06:00:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 20:12:00', '2026-01-17 18:54:01'],
                  'Isluga': ['2026-01-19 05:48:01', '2026-01-19 05:30:00', '2026-01-18 18:42:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 19:00:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01']
              },
              'VIIRS375': {
                  'Chaiten': ['2026-01-19 06:00:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 20:12:00', '2026-01-17 18:54:01'],
                  'ChillanNevadosde': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:12:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 06:36:01', '2026-01-17 06:12:00'],
                  'Copahue': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00', '2026-01-17 06:36:01'],
                  'Isluga': ['2026-01-19 05:48:01', '2026-01-19 05:30:00', '2026-01-18 18:42:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 19:00:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01'],
                  'Lascar': ['2026-01-19 05:54:01', '2026-01-19 05:30:00', '2026-01-18 18:36:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 19:00:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01'],
                  'Lastarria': ['2026-01-19 05:54:01', '2026-01-19 05:30:00', '2026-01-18 18:36:01', '2026-01-18 18:18:00', '2026-01-18 06:12:01', '2026-01-18 05:48:00', '2026-01-17 18:54:01', '2026-01-17 18:36:00', '2026-01-17 17:18:01', '2026-01-17 06:30:01'],
                  'Llaima': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00'],
                  'PlanchonPeteroa': ['2026-01-19 05:54:01', '2026-01-19 05:36:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:12:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:36:00', '2026-01-17 06:36:01'],
                  'PuyehueCordonCaulle': ['2026-01-19 05:36:00', '2026-01-18 19:54:00', '2026-01-18 18:36:01', '2026-01-18 18:12:00', '2026-01-18 06:18:01', '2026-01-18 05:54:00', '2026-01-18 04:36:01', '2026-01-17 18:54:01', '2026-01-17 18:30:00', '2026-01-17 06:36:01']
              },
              'MODIS': {
                  'ChillanNevadosde': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 19:25:00', '2026-01-17 14:00:00'],
                  'Copahue': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 06:30:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 19:25:00'],
                  'Lascar': ['2026-01-19 13:35:00', '2026-01-19 07:05:00', '2026-01-19 01:05:00', '2026-01-18 20:10:00', '2026-01-18 12:55:00', '2026-01-18 08:00:00', '2026-01-18 02:00:00', '2026-01-17 19:30:00', '2026-01-17 13:55:00', '2026-01-17 07:25:00'],
                  'Lastarria': ['2026-01-19 13:35:00', '2026-01-19 07:05:00', '2026-01-18 20:10:00', '2026-01-18 12:55:00', '2026-01-18 08:05:00', '2026-01-18 02:00:00', '2026-01-17 19:30:00', '2026-01-17 13:55:00', '2026-01-17 07:25:00', '2026-01-17 01:25:00'],
                  'PlanchonPeteroa': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:40:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 19:25:00', '2026-01-17 14:00:00'],
                  'PuyehueCordonCaulle': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 06:30:00', '2026-01-17 21:05:00', '2026-01-17 14:00:00', '2026-01-17 07:30:00'],
                  'Villarrica': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 06:30:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 14:00:00'],
                  'Llaima': ['2026-01-19 13:40:00', '2026-01-19 07:05:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 06:30:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 14:00:00'],
                  'Chaiten': ['2026-01-19 13:40:00', '2026-01-19 07:10:00', '2026-01-19 02:35:00', '2026-01-18 20:05:00', '2026-01-18 13:00:00', '2026-01-18 08:05:00', '2026-01-18 06:30:00', '2026-01-18 02:00:00', '2026-01-17 21:05:00', '2026-01-17 14:00:00'],
                  'Isluga': ['2026-01-19 13:35:00', '2026-01-19 07:05:00', '2026-01-19 01:05:00', '2026-01-18 20:10:00', '2026-01-18 12:55:00', '2026-01-18 08:00:00', '2026-01-18 02:00:00', '2026-01-17 19:30:00', '2026-01-17 13:55:00', '2026-01-17 07:25:00']
              }
          }
          
          def parse_blackbox_html(html_file):
              """Parse HTML y extraer eventos - FORMATO: 16-Jan-2026 02:24:01"""
              with open(html_file, 'r', encoding='utf-8') as f:
                  soup = BeautifulSoup(f.read(), 'html.parser')
              
              eventos = []
              table = soup.find('table', {'id': 'volcanoTable'})
              if not table:
                  return eventos
              
              tbody = table.find('tbody')
              if not tbody:
                  return eventos
              
              rows = tbody.find_all('tr')
              for row in rows:
                  cols = row.find_all('td')
                  if len(cols) >= 6:
                      try:
                          fecha_str = cols[0].text.strip()  # Formato: "16-Jan-2026 02:24:01"
                          volcano_link = cols[2].find('a')
                          volcan = volcano_link.text.strip() if volcano_link else cols[2].text.strip()
                          sensor = cols[5].text.strip()
                          
                          # Parsear fecha - FORMATO: "16-Jan-2026 02:24:01"
                          dt = datetime.strptime(fecha_str, '%d-%b-%Y %H:%M:%S')
                          
                          eventos.append({
                              'volcan': volcan,
                              'timestamp': dt,
                              'sensor': sensor
                          })
                      except Exception as e:
                          continue
              
              return eventos
          
          def buscar_evento(volcano, timestamp_str, sensor):
              """Busca evento en TODOS los HTMLs de la carpeta correcta"""
              target_dt = datetime.strptime(timestamp_str, '%Y-%m-%d %H:%M:%S')
              volcano_csv = VOLCANO_MAPPING.get(volcano, volcano)
              
              # Buscar en TODAS las carpetas de fechas
              base_path = Path(BLACKBOX_DIR)
              
              # Patr√≥n: blackbox_latest/*/latest_*.html
              html_pattern = str(base_path / "*" / "latest_*.html")
              html_files = glob.glob(html_pattern)
              
              for html_file in html_files:
                  eventos = parse_blackbox_html(html_file)
                  for evento in eventos:
                      if (evento['volcan'] == volcano_csv and 
                          evento['timestamp'] == target_dt and 
                          evento['sensor'] == sensor):
                          # Extraer info del archivo
                          filename = Path(html_file).name
                          folder = Path(html_file).parent.name
                          return True, f"{folder}/{filename}", target_dt
              
              return False, None, None
          
          print("="*80)
          print("VERIFICACI√ìN CORREGIDA: IM√ÅGENES vs BLACK BOX")
          print("="*80)
          
          # Contar archivos HTML
          base_path = Path(BLACKBOX_DIR)
          html_pattern = str(base_path / "*" / "latest_*.html")
          html_files = glob.glob(html_pattern)
          print(f"Snapshots encontrados: {len(html_files)}")
          
          # Mostrar carpetas
          folders = set([Path(f).parent.name for f in html_files])
          print(f"Carpetas de fechas: {sorted(folders)}")
          
          resultados = []
          total_encontrados = 0
          
          for sensor, volcanes in IMAGE_TIMESTAMPS.items():
              print(f"\n{sensor}:")
              for volcano, timestamps in volcanes.items():
                  encontrados = 0
                  for ts in timestamps:
                      found, snapshot, captura_dt = buscar_evento(volcano, ts, sensor)
                      if found:
                          encontrados += 1
                          total_encontrados += 1
                          status = "EN_BLACKBOX"
                          minuto = captura_dt.strftime('%Y-%m-%d %H:%M:%S') if captura_dt else "N/A"
                      else:
                          status = "NO_EN_BLACKBOX"
                          minuto = "N/A"
                          snapshot = "N/A"
                      resultados.append({
                          'Sensor': sensor,
                          'Volcan': volcano,
                          'Timestamp_Imagen': ts,
                          'Estado': status,
                          'Snapshot': snapshot if snapshot else "N/A",
                          'Minuto_Captura': minuto
                      })
                  print(f"  {volcano}: {encontrados}/{len(timestamps)} encontrados")
          
          df = pd.DataFrame(resultados)
          df.to_csv('monitoreo_satelital/analisis_imagenes_vs_blackbox_v2.csv', index=False)
          
          total = len(resultados)
          print(f"\n{'='*80}")
          print(f"RESUMEN: {total_encontrados}/{total} encontrados ({total_encontrados/total*100:.1f}%)")
          print(f"CSV guardado: monitoreo_satelital/analisis_imagenes_vs_blackbox_v2.csv")
          EOFPYTHON
      
      - name: Ejecutar verificaci√≥n CORREGIDA
        run: python3 verificar_blackbox.py
      
      - name: Commit y Push resultados
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git pull --rebase origin main
          git add monitoreo_satelital/analisis_imagenes_vs_blackbox_v2.csv
          git commit -m "üìä Verificaci√≥n Black Box v2 CORREGIDA: $(date +'%Y-%m-%d %H:%M')" || echo "No changes"
          git pull --rebase origin main
          git push
      
      - name: Mostrar resultados
        run: |
          echo "‚úÖ Verificaci√≥n completada"
          if [ -f monitoreo_satelital/analisis_imagenes_vs_blackbox_v2.csv ]; then
            echo "üìä Primeras 30 l√≠neas:"
            head -30 monitoreo_satelital/analisis_imagenes_vs_blackbox_v2.csv
          fi
